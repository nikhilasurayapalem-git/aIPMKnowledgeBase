<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduGenie Chatbot</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Custom scrollbar for aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* Gray-300 */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #f1f5f9; /* Gray-100 */
        }
        /* Ensure the body and html take full height */
        html, body, #root {
            height: 100%;
            margin: 0;
        }
    </style>
</head>
<body class="bg-gray-200">

<div id="root" class="flex justify-center items-center p-4">
    <!-- React app will render here -->
</div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const API_KEY_STORAGE_KEY = 'geminiApiKey';
    const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
    
    // --- API Key Setup Component ---

    const ApiKeySetup = ({ onApiKeySet }) => {
        const [keyInput, setKeyInput] = useState('');
        const [error, setError] = useState('');

        const handleSave = () => {
            if (keyInput.trim().length > 10) {
                // Simple length check for validity
                try {
                    localStorage.setItem(API_KEY_STORAGE_KEY, keyInput.trim());
                    setError('');
                    onApiKeySet(keyInput.trim());
                } catch (e) {
                    setError('Failed to save key to local storage.');
                }
            } else {
                setError('Please enter a valid, complete API Key.');
            }
        };

        return (
            <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-xl p-8 shadow-2xl w-full max-w-sm">
                    <h2 className="text-2xl font-bold mb-4 text-indigo-700">Set Up API Key</h2>
                    <p className="text-gray-600 mb-6">
                        To run the chatbot publicly, you need to provide your own Google Gemini API Key. This is stored securely only in your browser.
                    </p>
                    <input
                        type="password"
                        value={keyInput}
                        onChange={(e) => setKeyInput(e.target.value)}
                        placeholder="Enter your Gemini API Key"
                        className="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    />
                    {error && <p className="text-red-600 mb-4 text-sm">{error}</p>}
                    <button
                        onClick={handleSave}
                        className="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md"
                    >
                        Save Key & Start Chatbot
                    </button>
                    <p className="text-xs text-center text-gray-500 mt-4">
                        <a href="https://makersuite.google.com/app/apikey" target="_blank" className="text-indigo-500 hover:text-indigo-700">Get your key here</a>
                    </p>
                </div>
            </div>
        );
    };

    // --- API Utility Functions ---

    // Utility function for exponential backoff during API calls
    const fetchWithRetry = async (url, options, maxRetries = 5) => {
        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(url, options);
                
                // Check for 429 Too Many Requests
                if (response.status === 429) { 
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    console.warn(`429 received. Retrying in ${Math.round(delay / 1000)}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    continue;
                }
                
                if (!response.ok) {
                    // Check for 403/401 specifically for API Key errors
                    const errorDetails = await response.text();
                    if (response.status === 400 || response.status === 403) {
                         // Likely invalid API key format or key not authorized for this model/service
                         throw new Error(`API Key/Permission Error (Status ${response.status}): Check your key's validity and permissions.`);
                    }
                    throw new Error(`API Error (Status ${response.status}): ${response.statusText}. Details: ${errorDetails.substring(0, 100)}...`);
                }
                return response;

            } catch (error) {
                if (i === maxRetries - 1) {
                    console.error("Fetch failed after multiple retries:", error);
                    throw error;
                }
            }
        }
    };

    // --- Main RAG Component ---

    const initialContext = `
# Core AI/ML/PM/PjM Technical Reference

This context provides specialized definitions for technical and managerial topics. For all other general or public domain knowledge, you must use Google Search grounding.

1.  Data Drift vs. Concept Drift: Data drift is when input data characteristics change. Concept drift is when the relationship between input and target changes.
2.  MLOps CI/CD/CT: Continuous Training (CT) is unique to MLOps, ensuring models are automatically retrained on new data, differentiating it from traditional software development.
3.  AI Product Management: Requires managing non-deterministic features, focusing on model risk (bias, fairness), and defining metrics based on model impact, not just accuracy.
`;

    // Helper component for chat bubbles - Renders plain text only
    const ChatBubble = ({ message, role }) => {
        const isUser = role === 'user';
        const bgColor = isUser ? 'bg-indigo-600/90 text-white' : 'bg-gray-100 text-gray-800';
        
        return (
            <div className={`flex max-w-[85%] my-2 ${isUser ? 'justify-end' : 'justify-start'}`}>
                <div className={`flex items-start space-x-2 ${isUser ? 'flex-row-reverse space-x-reverse' : 'flex-row'}`}>
                    <div className={`px-4 py-3 rounded-xl shadow-md ${bgColor} ${isUser ? 'rounded-br-sm' : 'rounded-tl-sm'}`}>
                        {/* Render the message as plain text, using whitespace-pre-wrap for line breaks */}
                        <p className="whitespace-pre-wrap">{message}</p>
                    </div>
                </div>
            </div>
        );
    };


    const ChatbotApp = ({ apiKey }) => {
        const [messages, setMessages] = useState([]);
        const [input, setInput] = useState('');
        const [isLoading, setIsLoading] = useState(false);
        const chatEndRef = useRef(null);
        
        // Scroll to the latest message
        useEffect(() => {
            chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
        }, [messages]);

        const handleSendMessage = async (e) => {
            e.preventDefault();
            if (!input.trim() || isLoading) return;

            const userQuery = input.trim();
            const newMessages = [...messages, { role: 'user', content: userQuery }];
            setMessages(newMessages);
            setInput('');
            setIsLoading(true);
            
            const coreContext = initialContext.trim(); 
            
            // SYSTEM INSTRUCTION MODIFIED: Strictly disallowing all formatting (**, #, <strong>, etc.)
            const systemInstructionText = `You are a helpful, factual, and web-augmented expert capable of answering questions across all domains, from general public knowledge to specialized technical topics (AI, ML, Product Management, etc.).
                
                **Formatting Constraint:** Output must be plain text. Do NOT use any Markdown (like **, #, -, *) or HTML tags (like <strong>, <p>) in your response. Use simple line breaks for separation.
                
                **Dual Personality Guidance:**
                1. **General/Technical Queries:** For any question (except casual chit-chat), your answers must be grounded by combining your internal specialized knowledge (provided in CORE CONTEXT) and extensive, real-time information obtained via Google Search. Maintain a professional, concise, and highly accurate tone.
                2. **Casual/Conversational Queries (Chit-Chat):** If the user asks a non-technical question (e.g., "How are you?", "What time is it?", "Tell me a joke"), respond briefly and warmly in a human-like, friendly manner. Do not include any technical information about AI/ML, MLOps, or your function in the response. Do not use Google Search for chit-chat.

                --- CORE CONTEXT (Internal Knowledge Base for consistent foundational definitions) ---
                ${coreContext}`;
                
            const toolsConfig = [{ "google_search": {} }]; // Always use search

            const apiUrlWithKey = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;

            const apiPayload = {
                 contents: [{ role: 'user', parts: [{ text: userQuery }] }],
                 systemInstruction: { parts: [{ text: systemInstructionText }] },
                 tools: toolsConfig
            };


            try {
                const response = await fetchWithRetry(apiUrlWithKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(apiPayload)
                });

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "An unexpected error occurred.";

                setMessages((prev) => [
                    ...prev,
                    { role: 'model', content: text }
                ]);

            } catch (error) {
                console.error("API Call Error:", error);
                // Clear the messages on critical failure and show the key setup again if it's an authorization issue
                if (error.message.includes('API Key/Permission Error')) {
                    alert('Critical Error: The API key seems invalid or unauthorized. Please re-enter your key.');
                    localStorage.removeItem(API_KEY_STORAGE_KEY);
                    window.location.reload(); // Force refresh to show the setup modal
                } else {
                    setMessages((prev) => [
                        ...prev,
                        { role: 'model', content: `Error: Failed to connect to the model. ${error.message}` }
                    ]);
                }
            } finally {
                setIsLoading(false);
            }
        };

        return (
            <div className="flex flex-col h-full w-full antialiased justify-center items-center">
                
                {/* Main Chat Window Shell (Mobile style) */}
                <div className="flex flex-col w-full max-w-md h-[95vh] bg-white rounded-3xl shadow-2xl overflow-hidden border-4 border-indigo-700">
                    
                    {/* Custom Header */}
                    <div className="flex items-center justify-between p-4 bg-indigo-600 text-white shadow-lg">
                        <div className="flex items-center space-x-2">
                            {/* Genie/Bag/Store Icon Placeholder */}
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4 12.793 4 13a2 2 0 002 2h10a2 2 0 002-2 2 2 0 00-2-2H8.667l.5-1.5h4.94a1 1 0 00.953-.795l.946-4.729A1 1 0 0014.28 3H4.857a1 1 0 00-.798.577L3 5H2a1 1 0 000 2h1zm10 8H7.407l-.75-3H12l.6 3zM16 13a1 1 0 11-2 0 1 1 0 012 0zm-7 0a1 1 0 11-2 0 1 1 0 012 0z" />
                            </svg>
                            <span className="text-xl font-bold">EduGenie</span>
                        </div>
                        {/* Settings Button to re-enter API key */}
                        <button 
                            onClick={() => {
                                // Clear key and force refresh to show modal again
                                localStorage.removeItem(API_KEY_STORAGE_KEY);
                                window.location.reload(); 
                            }}
                            className="p-1 rounded-full hover:bg-indigo-500/50 transition"
                            title="Re-enter API Key"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6">
                              <path strokeLinecap="round" strokeLinejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.061.363.308.658.661.86l1.454.877c.825.499 1.767.249 2.271-.519l.214-.309a1.125 1.125 0 0 1 1.745-.31l1.454 1.454a1.125 1.125 0 0 1 .31 1.745l-.31.214c-.77.504-1.02 1.446-.519 2.271l.877 1.454c.202.353.497.6.86.661l1.281.213c.542.09.94.56.94 1.11v2.594c0 .55-.398 1.02-.94 1.11l-1.281.213c-.363.061-.658.308-.86.661l-.877 1.454c-.504.77-1.446 1.02-2.271.519l-.309-.214a1.125 1.125 0 0 1-.31-1.745l-1.454-1.454a1.125 1.125 0 0 1-1.745-.31l-.214.31c-.504.77-1.446 1.02-2.271.519l-1.454-.877a1.125 1.125 0 0 1-.661-.86l-.213-1.281a1.125 1.125 0 0 0-.94-1.11v-2.594c0-.55.398-1.02.94-1.11l1.281-.213c.363-.061.658-.308.86-.661l.877-1.454c.504-.77 1.446-1.02 2.271-.519l.31.214a1.125 1.125 0 0 1 1.745.31l1.454 1.454a1.125 1.125 0 0 1 .31 1.745l-.31.214c-.77.504-1.446 1.02-2.271.519l-.877-1.454a1.125 1.125 0 0 1-.661-.86l-.213-1.281z" />
                              <path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0z" />
                            </svg>
                        </button>
                    </div>

                    {/* Chat History (Answer Section) */}
                    <div className="flex-grow p-4 space-y-4 overflow-y-auto custom-scrollbar flex flex-col justify-start">
                        {messages.length === 0 ? (
                            <div className="flex items-center justify-center h-full">
                                <p className="text-gray-500 text-center p-8">
                                    Welcome! I am **EduGenie**, a web-augmented expert. Ask me anything about the world, or focus on specialized topics like AI and Product Management!
                                </p>
                            </div>
                        ) : (
                            messages.map((msg, index) => (
                                <ChatBubble key={index} message={msg.content} role={msg.role} />
                            ))
                        )}
                        <div ref={chatEndRef} />
                    </div>

                    {/* Input Area (Question Section) */}
                    <form onSubmit={handleSendMessage} className="p-3 bg-white border-t border-gray-100">
                        <div className="flex items-center space-x-2">
                            <input
                                type="text"
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                placeholder={isLoading ? "Generating response..." : "Ask your question..."}
                                className="flex-grow p-3 border-2 border-gray-300 rounded-full shadow-inner bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150 ease-in-out"
                                disabled={isLoading}
                            />
                            {/* Placeholder for the emoji/smile icon */}
                            <span className="text-2xl text-gray-500 cursor-pointer hidden sm:block">ðŸ˜€</span> 
                            <button
                                type="submit"
                                className={`p-3 rounded-full font-bold text-white shadow-lg transition duration-300 ease-in-out flex items-center justify-center
                                    ${isLoading
                                    ? 'bg-gray-400 cursor-not-allowed'
                                    : 'bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 transform hover:scale-[1.05]'
                                    }`}
                                disabled={isLoading}
                            >
                                {isLoading ? (
                                    <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                ) : (
                                    // Send Icon (paper airplane)
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 transform rotate-45 -mt-1 ml-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                                        <path strokeLinecap="round" strokeLinejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                    </svg>
                                )}
                            </button>
                        </div>
                    </form>
                    
                    {/* Footer branding element from image, simplified */}
                    <div className="text-xs text-gray-400 text-center py-1">
                        <span className="font-semibold text-indigo-500">âš¡ Chat</span> powered by Gemini
                    </div>

                </div>
            </div>
        );
    };

    // --- Main Root Component to Handle Key State ---

    const RootApp = () => {
        const [apiKey, setApiKey] = useState(null);
        const [isReady, setIsReady] = useState(false);

        // Checking local storage first, then setting the key state
        useEffect(() => {
            try {
                const storedKey = localStorage.getItem(API_KEY_STORAGE_KEY);
                if (storedKey) {
                    setApiKey(storedKey);
                }
            } catch (e) {
                console.error("Could not access local storage:", e);
            }
            setIsReady(true);
        }, []);
        
        if (!isReady) {
            return <div className="text-lg text-gray-500">Loading...</div>;
        }

        if (!apiKey) {
            return <ApiKeySetup onApiKeySet={setApiKey} />;
        }

        return <ChatbotApp apiKey={apiKey} />;
    };

    // Render the Root App
    ReactDOM.createRoot(document.getElementById('root')).render(<RootApp />);
</script>

</body>
</html>
